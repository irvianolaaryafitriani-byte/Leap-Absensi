<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LEAP Learning â€“ Absensi Kelas</title>

<style>
:root{
  --blue:#5bbcff;
  --yellow:#ffd600;
}
body{
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, var(--blue), #a7d8ff);
  padding:20px;
}
.card{
  background:#fff;
  max-width:420px;
  margin:auto;
  padding:25px;
  border-radius:16px;
  box-shadow:0 8px 20px rgba(0,0,0,0.15);
}
.logo{text-align:center;margin-bottom:10px}
.logo img{height:70px}
h3{text-align:center;margin-bottom:20px}
label{font-size:14px}
select,input,button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:8px;
  border:1px solid #ddd;
}
button{
  background:linear-gradient(90deg,var(--blue),var(--yellow));
  border:none;
  font-weight:bold;
  cursor:pointer;
}
.tag{
  background:#e0f2fe;
  padding:6px 10px;
  border-radius:6px;
  margin:4px 4px 0 0;
  display:inline-block;
}
#preview img,#preview video{
  width:90px;
  height:90px;
  object-fit:cover;
  border-radius:6px;
  margin:5px;
}
</style>
</head>

<body>

<div class="card">

<div class="logo">
  <img src="logo leap learning.jpg">
</div>

<!-- LOGIN -->
<div id="loginPage">
  <h3>Login Teacher</h3>
  <form id="loginForm">
    <label>Nama Teacher</label>
    <select id="loginTeacher" required>
      <option value="">-- Pilih Teacher --</option>
      <option>Ms. Nola</option>
      <option>Ms. Salsa</option>
      <option>Ms. Jihan</option>
      <option>Ms. Angel</option>
      <option>Ms. Iis</option>
      <option>Ms. Dhea</option>
      <option>Ms. Tika</option>
    </select>

    <label>PIN</label>
    <input type="password" id="loginPin" required>

    <button type="submit">Login</button>
  </form>
</div>

<!-- APP -->
<div id="appPage" style="display:none">
  <h3>Absensi Kelas</h3>

  <label>Kelas</label>
  <select id="kelas">
    <option value="">-- Pilih Program --</option>
    <option>Baca Tulis Anak Hebat</option>
    <option>English Club</option>
    <option>Playclass</option>
    <option>Prisma Kalkulator Tangan</option>
    <option>Prisma + Math/Mate</option>
    <option>Trial Class</option>
  </select>

  <label>Jam Sesi</label>
  <select id="jamSesi">
    <option value="">-- Pilih Jam --</option>
    <option>08.00-09.00</option>
    <option>09.00-10.00</option>
    <option>10.00-11.00</option>
    <option>11.00-12.00</option>
    <option>13.00-14.00</option>
    <option>14.00-15.00</option>
    <option>15.00-16.00</option>
    <option>16.00-17.00</option>
  </select>

  <label>Teacher</label>
  <select id="teacher">
    <option>Ms. Nola</option>
    <option>Ms. Salsa</option>
    <option>Ms. Jihan</option>
    <option>Ms. Angel</option>
    <option>Ms. Iis</option>
    <option>Ms. Dhea</option>
    <option>Ms. Tika</option>
  </select>

  <label>Asisten Teacher (opsional)</label>
  <select id="assistantTeacher" multiple size="3">
    <option>Ms. Nola</option>
    <option>Ms. Salsa</option>
    <option>Ms. Jihan</option>
    <option>Ms. Angel</option>
    <option>Ms. Iis</option>
    <option>Ms. Dhea</option>
    <option>Ms. Tika</option>
  </select>

  <label>Nama Murid</label>
  <input type="text" id="searchMurid" placeholder="Cari murid...">
  <select id="murid" multiple size="4"></select>
  <div id="selectedMurid"></div>

  <label>Status</label>
  <select id="status">
    <option>Hadir</option>
    <option>Izin</option>
    <option>Sakit</option>
  </select>

  <label>Dokumentasi (max 3)</label>
  <input type="file" id="files" multiple accept="image/*,video/*">
  <div id="preview"></div>

  <button id="submitBtn">Simpan Absensi</button>
  <button onclick="logout()" style="background:#ef4444;color:#fff">Logout</button>
</div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxwkvyr07PoKOWZQjaiQayRcOpybflJcpbB3LCbhlZqMtYR2RqYpUs4MtrEbPwIc2idfw/exec";

const loginPage = document.getElementById("loginPage");
const appPage = document.getElementById("appPage");
const muridEl = document.getElementById("murid");
const selectedMurid = document.getElementById("selectedMurid");

let students = [];

/* LOGIN */
loginForm.onsubmit = e => {
  e.preventDefault();
  fetch(`${API_URL}?action=login&teacher=${loginTeacher.value}&pin=${loginPin.value}`)
    .then(r=>r.json())
    .then(d=>{
      if(!d.success) return alert(d.message || "Login gagal");
      localStorage.setItem("teacherLogin", loginTeacher.value);
      loginPage.style.display="none";
      appPage.style.display="block";
      teacher.value = loginTeacher.value;
    });
};

/* AUTO LOGIN */
window.onload = ()=>{
  fetch(API_URL+"?action=students")
    .then(r=>r.json())
    .then(d=>students=d);

  const t = localStorage.getItem("teacherLogin");
  if(t){
    loginPage.style.display="none";
    appPage.style.display="block";
    teacher.value = t;
  }
};

/* LOGOUT */
function logout(){
  localStorage.clear();
  location.reload();
}

/* FILTER MURID */
function renderMurid(){
  muridEl.innerHTML="";
  const keyword = searchMurid.value.toLowerCase();
  students.forEach(s=>{
    const nama = (s[0]||"").toLowerCase();
    const kelas = (s[2]||"").toLowerCase();
    if(
      (!kelas.value || kelas.includes(kelasEl.value.toLowerCase())) &&
      nama.includes(keyword)
    ){
      muridEl.innerHTML+=`<option>${s[0]}</option>`;
    }
  });
}

kelas.onchange = renderMurid;
searchMurid.onkeyup = renderMurid;

/* MULTI SELECT */
muridEl.onchange = ()=>{
  selectedMurid.innerHTML="";
  [...muridEl.selectedOptions].forEach(o=>{
    selectedMurid.innerHTML+=`<span class="tag">${o.value}</span>`;
  });
};

/* PREVIEW */
files.onchange = ()=>{
  preview.innerHTML="";
  if(files.files.length>3){alert("Max 3 file");files.value="";return;}
  [...files.files].forEach(f=>{
    const r=new FileReader();
    r.onload=e=>{
      preview.innerHTML+=f.type.startsWith("image")
      ?`<img src="${e.target.result}">`
      :`<video src="${e.target.result}" controls></video>`;
    };
    r.readAsDataURL(f);
  });
};

/* SUBMIT */
submitBtn.onclick = async()=>{
  if(!kelas.value||!jamSesi.value||muridEl.selectedOptions.length===0)
    return alert("Lengkapi data");

  let filesArr=[];
  for(const f of files.files){
    const b=await toBase64(f);
    filesArr.push({name:f.name,type:f.type,data:b.split(",")[1]});
  }

  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      kelas:kelas.value,
      jamSesi:jamSesi.value,
      teacher:teacher.value,
      assistantTeacher:[...assistantTeacher.selectedOptions].map(o=>o.value),
      murid:[...muridEl.selectedOptions].map(o=>o.value),
      status:status.value,
      files:filesArr
    })
  });

  alert("Great! Absensi berhasil disimpan. Terima kasih telah menemani proses belajar hari ini ${localStorage.getItem("teacherLogin")} ðŸ’›");
  location.reload();
};

function toBase64(f){
  return new Promise(r=>{
    const fr=new FileReader();
    fr.onload=()=>r(fr.result);
    fr.readAsDataURL(f);
  });
}
</script>

</body>
</html>
