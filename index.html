<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LEAP Learning – Absensi Kelas</title>

<style>
:root{
  --blue:#5bbcff;
  --yellow:#ffd600;
}
body{
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, var(--blue), #a7d8ff);
  padding:20px;
}
.card{
  background:#fff;
  max-width:420px;
  margin:auto;
  padding:25px;
  border-radius:16px;
  box-shadow:0 8px 20px rgba(0,0,0,0.15);
}
.logo{text-align:center;margin-bottom:10px}
.logo img{height:70px}
h3{text-align:center;margin-bottom:20px}
label{font-size:14px;margin-top:10px;display:block}
select,input,button{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:8px;
  border:1px solid #ddd;
}
button{
  background:linear-gradient(90deg,var(--blue),var(--yellow));
  border:none;
  font-weight:bold;
  cursor:pointer;
  margin-top:15px;
}
.tag{
  background:#e0f2fe;
  padding:6px 10px;
  border-radius:6px;
  margin:4px;
  display:inline-block;
}
#muridList{
  border:1px solid #ddd;
  border-radius:8px;
  max-height:160px;
  overflow:auto;
  padding:6px;
  margin-top:6px;
}
.murid-item{
  display:flex;
  align-items:center;
  gap:6px;
  padding:4px;
}
#loadingBox{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.loading-card{
  background:#fff;
  padding:22px 26px;
  border-radius:12px;
  text-align:center;
  max-width:280px;
}
</style>
</head>

<body>

<div class="card">
  <div class="logo">
    <img src="logo leap learning.jpg">
  </div>

  <!-- LOGIN -->
  <div id="loginPage">
    <h3>Login Teacher</h3>
    <form id="loginForm">
      <label>Nama Teacher</label>
      <select id="loginTeacher" required>
        <option value="">-- Pilih Teacher --</option>
        <option>Ms. Nola</option>
        <option>Ms. Salsa</option>
        <option>Ms. Jihan</option>
        <option>Ms. Angel</option>
        <option>Ms. Iis</option>
        <option>Ms. Dhea</option>
        <option>Ms. Tika</option>
      </select>

      <label>PIN</label>
      <input type="password" id="loginPin" required>

      <button type="submit">Login</button>
    </form>
  </div>

  <!-- APP -->
  <div id="appPage" style="display:none">
    <h3>Absensi Kelas</h3>

    <label>Kelas</label>
    <select id="kelas" required>
      <option value="">-- Pilih Program --</option>
      <option>Baca Tulis Anak Hebat</option>
      <option>English Club</option>
      <option>Playclass</option>
      <option>Trial Class</option>
    </select>

    <label>Jam Sesi</label>
    <select id="jamSesi" required>
      <option value="">-- Pilih Jam --</option>
      <option>08.00-09.00</option>
      <option>09.00-10.00</option>
      <option>10.00-11.00</option>
      <option>11.00-12.00</option>
      <option>13.00-14.00</option>
      <option>14.00-15.00</option>
      <option>15.00-16.00</option>
      <option>16.00-17.00</option>
    </select>

    <label>Teacher</label>
    <select id="teacher">
      <option>Ms. Nola</option>
      <option>Ms. Salsa</option>
      <option>Ms. Jihan</option>
      <option>Ms. Angel</option>
      <option>Ms. Iis</option>
      <option>Ms. Dhea</option>
      <option>Ms. Tika</option>
    </select>

    <label>Asisten Teacher (opsional)</label>
    <select id="assistantTeacher" multiple size="3">
      <option>Ms. Nola</option>
      <option>Ms. Salsa</option>
      <option>Ms. Jihan</option>
      <option>Ms. Angel</option>
      <option>Ms. Iis</option>
      <option>Ms. Dhea</option>
      <option>Ms. Tika</option>
    </select>

    <label>Nama Murid</label>
    <input type="text" id="searchMurid" placeholder="Ketik nama murid...">
    <div id="muridList"></div>

    <label>Status</label>
    <select id="status">
      <option>Hadir</option>
      <option>Izin</option>
      <option>Sakit</option>
    </select>

    <label>Dokumentasi (max 3 file)</label>
    <input type="file" id="files" multiple accept="image/*,video/*">

    <button id="submitBtn">Simpan Absensi</button>
    <button onclick="logout()" style="background:#ef4444;color:#fff">Logout</button>
  </div>
</div>

<div id="loadingBox">
  <div class="loading-card">
    <h4>⏳ Menyimpan absensi…</h4>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxwkvyr07PoKOWZQjaiQayRcOpybflJcpbB3LCbhlZqMtYR2RqYpUs4MtrEbPwIc2idfw/exec";

let students = [];
let selected = [];

/* ===== IMAGE COMPRESS ===== */
async function compressImage(file, maxWidth = 1280, quality = 0.7) {
  return new Promise(resolve => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;

    img.onload = () => {
      let { width, height } = img;
      if (width > maxWidth) {
        height = Math.round(height * (maxWidth / width));
        width = maxWidth;
      }
      const canvas = document.createElement("canvas");
      canvas.width = width;
      canvas.height = height;
      canvas.getContext("2d").drawImage(img, 0, 0, width, height);

      canvas.toBlob(blob => {
        const r = new FileReader();
        r.onload = () => resolve({
          name: file.name.replace(/\.\w+$/, ".jpg"),
          type: "image/jpeg",
          data: r.result.split(",")[1]
        });
        r.readAsDataURL(blob);
      }, "image/jpeg", quality);
    };

    reader.readAsDataURL(file);
  });
}

/* ===== MAIN ===== */
document.addEventListener("DOMContentLoaded", () => {

  loginForm.onsubmit = e => {
    e.preventDefault();
    login();
  };

  submitBtn.onclick = submitAbsensi;

  fetch(API_URL+"?action=students")
    .then(r=>r.json())
    .then(d=>students=d);

  searchMurid.oninput = () => {
    muridList.innerHTML="";
    students.forEach(s=>{
      if(s[0].toLowerCase().includes(searchMurid.value.toLowerCase())){
        muridList.innerHTML+=`
          <div class="murid-item">
            <input type="checkbox" value="${s[0]}" onchange="toggle(this)"> ${s[0]}
          </div>`;
      }
    });
  };
});

function toggle(cb){
  cb.checked
    ? selected.push(cb.value)
    : selected = selected.filter(x=>x!==cb.value);
}

function login(){
  fetch(`${API_URL}?action=login&teacher=${loginTeacher.value}&pin=${loginPin.value}`)
    .then(r=>r.json())
    .then(d=>{
      if(!d.success) return alert(d.message);
      loginPage.style.display="none";
      appPage.style.display="block";
    });
}

function logout(){
  selected = [];
  loginPage.style.display="block";
  appPage.style.display="none";
}

async function submitAbsensi(){
  if(selected.length===0) return alert("Pilih murid");

  loadingBox.style.display="flex";

  const files = Array.from(filesInput.files).slice(0,3);
  const fileData = [];

  for (const file of files) {
    if (file.type.startsWith("image/")) {
      fileData.push(await compressImage(file));
    } else {
      const raw = await new Promise(res=>{
        const r = new FileReader();
        r.onload = () => res({
          name:file.name,
          type:file.type,
          data:r.result.split(",")[1]
        });
        r.readAsDataURL(file);
      });
      fileData.push(raw);
    }
  }

  const res = await fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      kelas:kelas.value,
      jamSesi:jamSesi.value,
      teacher:teacher.value,
      assistantTeacher:[...assistantTeacher.selectedOptions].map(o=>o.value),
      murid:selected,
      status:status.value,
      files:fileData
    })
  });

  const result = await res.json();
  loadingBox.style.display="none";

  alert(result.success ? "Absensi berhasil" : "Gagal: "+result.message);
}
</script>

</body>
</html>
