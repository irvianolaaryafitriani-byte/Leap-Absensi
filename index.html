<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LEAP Learning ‚Äì Absensi Kelas</title>

<style>
body{
  font-family:Arial;
  background:#5bbcff;
  padding:20px
}
.card{
  background:#fff;
  max-width:420px;
  margin:auto;
  padding:25px;
  border-radius:14px
}
label{display:block;margin-top:10px}
select,input,button{
  width:100%;
  padding:10px;
  margin-top:6px
}
button{
  background:#ffd600;
  border:none;
  font-weight:bold
}
#muridList div{margin:4px 0}
#loadingBox{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  align-items:center;
  justify-content:center
}
</style>
</head>

<body>

<div class="card">

  <!-- LOGIN -->
  <div id="loginPage">
    <h3>Login Teacher</h3>
    <select id="loginTeacher">
      <option>Ms. Nola</option>
      <option>Ms. Salsa</option>
    </select>
    <input type="password" id="loginPin" placeholder="PIN">
    <button onclick="login()">Login</button>
  </div>

  <!-- APP -->
  <div id="appPage" style="display:none">
    <label>Kelas</label>
    <select id="kelas">
      <option>Baca Tulis Anak Hebat</option>
      <option>English Club</option>
      <option>Playclass</option>
    </select>

    <label>Jam Sesi</label>
    <select id="jamSesi">
      <option>08.00-09.00</option>
      <option>09.00-10.00</option>
    </select>

    <label>Teacher</label>
    <select id="teacher">
      <option>Ms. Nola</option>
      <option>Ms. Salsa</option>
    </select>

    <label>Nama Murid</label>
    <input id="searchMurid" placeholder="Cari murid">
    <div id="muridList"></div>

    <label>Status</label>
    <select id="status">
      <option>Hadir</option>
      <option>Izin</option>
      <option>Sakit</option>
    </select>

    <!-- üî• UPLOAD DOKUMENTASI -->
    <label>Dokumentasi (max 3 file)</label>
    <input type="file" id="files" multiple accept="image/*,video/*">

    <button onclick="submitAbsensi()">Simpan Absensi</button>
  </div>
</div>

<div id="loadingBox">
  <div class="card">‚è≥ Menyimpan data‚Ä¶</div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxwkvyr07PoKOWZQjaiQayRcOpybflJcpbB3LCbhlZqMtYR2RqYpUs4MtrEbPwIc2idfw/exec";

let students = [];
let selected = [];

fetch(API_URL+"?action=students")
  .then(r=>r.json())
  .then(d=>students=d);

searchMurid.oninput=()=>{
  muridList.innerHTML="";
  students.forEach(s=>{
    if(s[0].toLowerCase().includes(searchMurid.value.toLowerCase())){
      muridList.innerHTML+=`
        <div>
          <input type="checkbox" value="${s[0]}" onchange="toggle(this)"> ${s[0]}
        </div>`;
    }
  });
};

function toggle(cb){
  cb.checked
    ? selected.push(cb.value)
    : selected = selected.filter(x=>x!==cb.value);
}

function login(){
  fetch(`${API_URL}?action=login&teacher=${loginTeacher.value}&pin=${loginPin.value}`)
    .then(r=>r.json())
    .then(d=>{
      if(!d.success) return alert(d.message);
      loginPage.style.display="none";
      appPage.style.display="block";
    });
}

async function submitAbsensi(){
  if(selected.length===0) return alert("Pilih murid");

  loadingBox.style.display="flex";

  const filesInput = document.getElementById("files");
  const files = Array.from(filesInput.files).slice(0,3);

  const fileData = await Promise.all(
    files.map(f=>new Promise(res=>{
      const reader = new FileReader();
      reader.onload = () => res({
        name: f.name,
        type: f.type,
        data: reader.result.split(",")[1]
      });
      reader.readAsDataURL(f);
    }))
  );

  const res = await fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      kelas:kelas.value,
      jamSesi:jamSesi.value,
      teacher:teacher.value,
      assistantTeacher:[],
      murid:selected,
      status:status.value,
      files:fileData
    })
  });

  const result = await res.json();
  loadingBox.style.display="none";

  alert(result.success ? "Absensi berhasil" : "Gagal: "+result.message);
}
</script>

</body>
</html>
